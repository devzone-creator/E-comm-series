<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../../partials/head') %>
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-header h1 {
            margin: 0;
        }
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .filters-section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .filters-form {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .products-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .table tr:hover {
            background: #f8f9fa;
        }
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .stock-low {
            color: #dc3545;
            font-weight: 600;
        }
        .stock-good {
            color: #28a745;
        }
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        .pagination a,
        .pagination span {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
        }
        .pagination a:hover {
            background: #f8f9fa;
        }
        .pagination .current {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .no-products {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div>
                <h1>Product Management</h1>
                <p>Manage your AfriGlam product catalog</p>
            </div>
            <a href="/admin/products/new" class="btn">Add New Product</a>
        </div>

        <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success">
                <%= success %>
            </div>
        <% } %>

        <!-- Filters Section -->
        <div class="filters-section">
            <form class="filters-form" method="GET">
                <div class="form-group">
                    <label for="search">Search Products</label>
                    <input 
                        type="text" 
                        id="search" 
                        name="search" 
                        class="form-control"
                        placeholder="Search by name or description..."
                        value="<%= filters.search %>"
                    >
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category" class="form-control">
                        <option value="">All Categories</option>
                        <% categories.forEach(cat => { %>
                            <option value="<%= cat.name %>" <%= filters.category === cat.name ? 'selected' : '' %>>
                                <%= cat.name %>
                            </option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn">Filter</button>
                    <a href="/admin/products" class="btn btn-secondary">Clear</a>
                </div>
            </form>
        </div>

        <!-- Products Table -->
        <div class="products-table">
            <% if (products.length > 0) { %>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% products.forEach(product => { %>
                            <tr>
                                <td>
                                    <% if (product.image_url) { %>
                                        <img src="<%= product.image_url %>" alt="<%= product.name %>" class="product-image">
                                    <% } else { %>
                                        <div class="product-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #666;">
                                            No Image
                                        </div>
                                    <% } %>
                                </td>
                                <td>
                                    <div>
                                        <strong><%= product.name %></strong>
                                        <% if (product.sku) { %>
                                            <br><small>SKU: <%= product.sku %></small>
                                        <% } %>
                                    </div>
                                </td>
                                <td><%= product.category_name || 'No Category' %></td>
                                <td>â‚µ<%= parseFloat(product.price).toFixed(2) %></td>
                                <td>
                                    <span class="<%= product.stock_quantity <= 5 ? 'stock-low' : 'stock-good' %>">
                                        <%= product.stock_quantity %>
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge <%= product.is_active ? 'status-active' : 'status-inactive' %>">
                                        <%= product.is_active ? 'Active' : 'Inactive' %>
                                    </span>
                                </td>
                                <td>
                                    <div class="actions">
                                        <a href="/admin/products/<%= product.id %>/edit" class="btn btn-sm btn-secondary">Edit</a>
                                        <button 
                                            onclick="deleteProduct('<%= product.id %>', '<%= product.name %>')" 
                                            class="btn btn-sm btn-danger"
                                        >
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>

                <!-- Pagination -->
                <% if (pagination.pages > 1) { %>
                    <div class="pagination">
                        <% if (pagination.page > 1) { %>
                            <a href="?page=<%= pagination.page - 1 %>&search=<%= filters.search %>&category=<%= filters.category %>">Previous</a>
                        <% } %>
                        
                        <% for (let i = 1; i <= pagination.pages; i++) { %>
                            <% if (i === pagination.page) { %>
                                <span class="current"><%= i %></span>
                            <% } else { %>
                                <a href="?page=<%= i %>&search=<%= filters.search %>&category=<%= filters.category %>"><%= i %></a>
                            <% } %>
                        <% } %>
                        
                        <% if (pagination.page < pagination.pages) { %>
                            <a href="?page=<%= pagination.page + 1 %>&search=<%= filters.search %>&category=<%= filters.category %>">Next</a>
                        <% } %>
                    </div>
                <% } %>
            <% } else { %>
                <div class="no-products">
                    <h3>No products found</h3>
                    <p>Start by adding your first product to the catalog.</p>
                    <a href="/admin/products/new" class="btn">Add New Product</a>
                </div>
            <% } %>
        </div>
    </div>

    <script>
        function deleteProduct(productId, productName) {
            if (confirm(`Are you sure you want to delete "${productName}"? This action cannot be undone.`)) {
                fetch(`/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting product: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting product');
                });
            }
        }

        // Get URL parameters for success message
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        if (success) {
            // Remove success parameter from URL
            const newUrl = window.location.pathname + (window.location.search.replace(/[?&]success=[^&]*/, '').replace(/^&/, '?') || '');
            window.history.replaceState({}, '', newUrl);
        }
    </script>
</body>
</html>