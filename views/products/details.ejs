<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head.ejs') %>
        <style>
            .product-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
            }

            .product-details {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 3rem;
                margin-bottom: 3rem;
            }

            .product-image-section {
                display: flex;
                flex-direction: column;
            }

            .main-image {
                width: 100%;
                height: 300px;
                object-fit: cover;
                border-radius: 10px;
                margin-bottom: 1rem;
            }

            .image-placeholder {
                width: 100%;
                height: 500px;
                background: #f8f9fa;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #666;
                border-radius: 10px;
                margin-bottom: 1rem;
            }

            .product-info {
                padding: 1rem 0;
            }

            .product-title {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 1rem;
                color: #333;
            }

            .product-category {
                color: #667eea;
                font-size: 1.1rem;
                margin-bottom: 1rem;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .product-price {
                font-size: 2rem;
                font-weight: 700;
                color: #28a745;
                margin-bottom: 1.5rem;
            }

            .product-description {
                font-size: 1.1rem;
                line-height: 1.6;
                color: #666;
                margin-bottom: 2rem;
            }

            .product-stock {
                margin-bottom: 2rem;
                font-size: 1.1rem;
            }

            .stock-good {
                color: #28a745;
            }

            .stock-low {
                color: #ffc107;
            }

            .stock-out {
                color: #dc3545;
            }

            .product-variants {
                margin-bottom: 2rem;
            }

            .variant-group {
                margin-bottom: 1.5rem;
            }

            .variant-label {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                display: block;
                color: #333;
            }

            .variant-select {
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                background: white;
            }

            .variant-select:focus {
                border-color: #667eea;
                outline: none;
            }

            .add-to-cart-section {
                border-top: 2px solid #f8f9fa;
                padding-top: 2rem;
            }

            .quantity-section {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 2rem;
            }

            .quantity-label {
                font-size: 1.1rem;
                font-weight: 600;
                color: #333;
            }

            .quantity-input {
                width: 80px;
                padding: 0.75rem;
                border: 2px solid #ddd;
                border-radius: 8px;
                text-align: center;
                font-size: 1rem;
            }

            .add-to-cart-btn {
                width: 100%;
                background: #28a745;
                color: white;
                border: none;
                padding: 1rem 2rem;
                border-radius: 8px;
                font-size: 1.2rem;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.3s;
                margin-bottom: 1rem;
            }

            .add-to-cart-btn:hover {
                background: #218838;
            }

            .add-to-cart-btn:disabled {
                background: #6c757d;
                cursor: not-allowed;
            }

            .continue-shopping {
                width: 100%;
                background: #667eea;
                color: white;
                border: none;
                padding: 0.75rem 2rem;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                text-align: center;
                transition: background-color 0.3s;
            }

            .continue-shopping:hover {
                background: #5a67d8;
                color: white;
                text-decoration: none;
            }

            .alert {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 8px;
            }

            .alert-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .alert-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            @media (max-width: 768px) {
                .product-details {
                    grid-template-columns: 1fr;
                    gap: 2rem;
                }

                .product-title {
                    font-size: 2rem;
                }
            }
        </style>
</head>

<body>
    <%- include('../partials/nav.ejs') %>

        <div class="product-container">
            <!-- Success/Error Messages -->
            <div id="messages"></div>

            <div class="product-details">
                <!-- Product Image -->
                <div class="product-image-section">
                    <% if (product.image_url) { %>
                        <img src="<%= product.image_url %>" alt="<%= product.name %>" class="main-image">
                        <% } else { %>
                            <div class="image-placeholder">
                                <span>No Image Available</span>
                            </div>
                            <% } %>
                </div>

                <!-- Product Info -->
                <div class="product-info">
                    <h1 class="product-title">
                        <%= product.name %>
                    </h1>

                    <% if (product.category_name) { %>
                        <div class="product-category">
                            <%= product.category_name %>
                        </div>
                        <% } %>

                            <div class="product-price">₵<%= parseFloat(product.price).toFixed(2) %>
                            </div>

                            <% if (product.description) { %>
                                <div class="product-description">
                                    <%= product.description %>
                                </div>
                                <% } %>

                                    <div class="product-stock">
                                        <% if (product.stock_quantity> 10) { %>
                                            <span class="stock-good">✓ In Stock (<%= product.stock_quantity %>
                                                    available)</span>
                                            <% } else if (product.stock_quantity> 0) { %>
                                                <span class="stock-low">⚠ Low Stock (<%= product.stock_quantity %>
                                                        left)</span>
                                                <% } else { %>
                                                    <span class="stock-out">✗ Out of Stock</span>
                                                    <% } %>
                                    </div>

                                    <% if (product.stock_quantity> 0) { %>
                                        <form id="add-to-cart-form">
                                            <div class="product-variants">
                                                <% if (product.sizes && product.sizes !=='null' && product.sizes !=='' )
                                                    { %>
                                                    <div class="variant-group">
                                                        <label class="variant-label" for="size">Size:</label>
                                                        <select class="variant-select" id="size" name="size">
                                                            <option value="">Select Size</option>
                                                            <% try { const sizes=typeof product.sizes==='string' ?
                                                                JSON.parse(product.sizes) : product.sizes; if
                                                                (Array.isArray(sizes)) { sizes.forEach(size=> { %>
                                                                <option value="<%= size %>">
                                                                    <%= size %>
                                                                </option>
                                                                <% }); } } catch (e) { // Handle parsing error silently
                                                                    } %>
                                                        </select>
                                                    </div>
                                                    <% } %>

                                                        <% if (product.colors && product.colors !=='null' &&
                                                            product.colors !=='' ) { %>
                                                            <div class="variant-group">
                                                                <label class="variant-label" for="color">Color:</label>
                                                                <select class="variant-select" id="color" name="color">
                                                                    <option value="">Select Color</option>
                                                                    <% try { const colors=typeof
                                                                        product.colors==='string' ?
                                                                        JSON.parse(product.colors) : product.colors; if
                                                                        (Array.isArray(colors)) { colors.forEach(color=>
                                                                        { %>
                                                                        <option value="<%= color %>">
                                                                            <%= color %>
                                                                        </option>
                                                                        <% }); } } catch (e) { // Handle parsing error
                                                                            silently } %>
                                                                </select>
                                                            </div>
                                                            <% } %>
                                            </div>

                                            <div class="add-to-cart-section">
                                                <div class="quantity-section">
                                                    <label class="quantity-label" for="quantity">Quantity:</label>
                                                    <input type="number" id="quantity" name="quantity"
                                                        class="quantity-input" value="1" min="1"
                                                        max="<%= product.stock_quantity %>">
                                                </div>

                                                <button type="submit" class="add-to-cart-btn">
                                                    Add to Cart
                                                </button>
                                            </div>
                                        </form>
                                        <% } else { %>
                                            <div class="add-to-cart-section">
                                                <button class="add-to-cart-btn" disabled>Out of Stock</button>
                                            </div>
                                            <% } %>

                                                <a href="/shop" class="continue-shopping">← Continue Shopping</a>
                </div>
            </div>
        </div>

        <%- include('../partials/footer.ejs') %>

            <script>
                // Handle add to cart form submission
                document.getElementById('add-to-cart-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = new FormData(e.target);
                    const productId = '<%= product.id %>';
                    const quantity = parseInt(formData.get('quantity'));
                    const size = formData.get('size') || null;
                    const color = formData.get('color') || null;

                    console.log('Adding to cart:', { productId, quantity, size, color });

                    try {
                        const response = await fetch('/api/cart/add', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include', // Include session cookies
                            body: JSON.stringify({
                                productId,
                                quantity,
                                size,
                                color
                            })
                        });

                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('Response data:', data);

                        if (data.success) {
                            showSuccess('Item added to cart successfully!');
                            // Redirect to cart page after 1 second
                            setTimeout(() => {
                                window.location.href = '/cart';
                            }, 1000);
                        } else {
                            if (response.status === 401) {
                                // User not logged in, redirect to login
                                window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                            } else {
                                showError(data.message || 'Failed to add item to cart');
                            }
                        }
                    } catch (error) {
                        console.error('Error adding to cart:', error);
                        showError('Unable to add item to cart. Trying alternative method...');
                        
                        // Fallback to form submission
                        setTimeout(() => {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = '/cart/add';

                            const inputs = [
                                { name: 'productId', value: productId },
                                { name: 'quantity', value: quantity },
                                { name: 'redirect', value: '/cart' }
                            ];

                            if (size) inputs.push({ name: 'size', value: size });
                            if (color) inputs.push({ name: 'color', value: color });

                            inputs.forEach(input => {
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = input.name;
                                hiddenInput.value = input.value;
                                form.appendChild(hiddenInput);
                            });

                            document.body.appendChild(form);
                            form.submit();
                        }, 1500);
                    }
                });

                // Show success message
                function showSuccess(message) {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = `<div class="alert alert-success">${message}</div>`;
                }

                // Show error message
                function showError(message) {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = `<div class="alert alert-error">${message}</div>`;
                }

                // Handle URL parameters for messages
                const urlParams = new URLSearchParams(window.location.search);
                const success = urlParams.get('success');
                const error = urlParams.get('error');

                if (success) {
                    showSuccess(success);
                }
                if (error) {
                    showError(error);
                }
            </script>
</body>

</html>